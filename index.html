<html>
  <head>
    <script src="https://aframe.io/releases/1.0.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.1.0/dist/aframe-environment-component.min.js"></script>
  </head>
  <body>
    <script>
      AFRAME.registerComponent("camera-move", {
        schema: {
          speed: { type: "number", default: 0.01 }
        },
        tick: function() {
          var el = this.el;
          var positionTmp = (this.positionTmp = this.positionTmp || {
            x: 0,
            y: 2,
            z: 0
          });
          var position = el.getAttribute("position");
          // positionTmp.x = position.x + 0.1;
          // positionTmp.y = position.y + 0.001;
          positionTmp.z = position.z - 0.003;
          el.setAttribute("position", positionTmp);
        }
      });

      AFRAME.registerComponent("raycaster-listen", {
        init: function() {
          // Use events to figure out what raycaster is listening so we don't have to
          // hardcode the raycaster.
          this.el.addEventListener("raycaster-intersected", evt => {
            this.raycaster = evt.detail.el;
          });
          this.el.addEventListener("raycaster-intersected-cleared", evt => {
            this.raycaster = null;
          });

          this.leftPoint = document.querySelector("#left-point");
          this.rightPoint = document.querySelector("#right-point");
          this.viewPoint = document.querySelector("#view-point");
        },

        tick: function() {
          if (!this.raycaster) {
            return;
          } // Not intersecting.

          let intersection = this.raycaster.components.raycaster.getIntersection(
            this.el
          );
          if (!intersection) {
            return;
          }
          //   console.log(this.raycaster);
          //   console.log(intersection.point);
          const p = intersection.point;

          if (this.raycaster.id === "left-hand") {
            this.leftPoint.object3D.position.set(p.x, p.y, p.z);
          }

          if (this.raycaster.id === "right-hand") {
            this.rightPoint.object3D.position.set(p.x, p.y, p.z);
          }

          if (this.raycaster.id === "cursor") {
            this.viewPoint.object3D.position.set(p.x, p.y, p.z);
          }
        }
      });

      AFRAME.registerComponent("modify-materials", {
        init: function() {
          // Wait for model to load.
          this.el.addEventListener("model-loaded", () => {
            // Grab the mesh / scene.
            const obj = this.el.getObject3D("mesh");
            // Go over the submeshes and modify materials we want.
            obj.traverse(node => {
              console.log(node);
              if (node.name.indexOf("lamp") !== -1) {
                node.material = new THREE.MeshBasicMaterial();
                node.material.color.set("#f90");
              }
            });
          });
        }
      });
    </script>

    <a-scene
      background="color: black"
      pool__enemy="mixin: enemy; size: 6"
      inspector="https://cdn.jsdelivr.net/gh/aframevr/aframe-inspector@master/dist/aframe-inspector.min.js"
      environment="preset: tron; ground: flat; fog: 0.9; skyType: gradient; horizonColor: #420; gridColor: #c60; dressing: torii; dressingAmount: 60; dressingScale: 1; dressingUniformScale: true"
    >
      <a-assets>
        <a-mixin
          id="enemy"
          gltf-model="#enemy1"
          sound="src: #explode; on: click; volume: 10"
          scale="0.5 0.5 0.5"
          animation="property: rotation; dur: 500"
          modify-materials
        >
        </a-mixin>

        <a-mixin
          id="enemy2"
          gltf-model="#enemy-model-2"
          sound="src: #explode; on: click; volume: 10"
          scale="0.5 0.5 0.5"
          animation="property: rotation; dur: 500"
          modify-materials
        >
        </a-mixin>

        <a-mixin id="enemy1-anim"></a-mixin>

        <a-asset-item
          id="enemy1"
          src="assets/models/enemy1.gltf"
        ></a-asset-item>

        <a-asset-item
          id="enemy-model-2"
          src="assets/models/enemy2.gltf"
        ></a-asset-item>

        <img id="chevron" src="assets/textures/gray-chevron.jpg" />

        <audio
          id="zap"
          src="assets/sounds/sound_spark_Laser-Like_Synth_Basic_Laser2_04.mp3"
          poolsize="5"
          preload="auto"
        ></audio>

        <audio
          id="zap2"
          src="assets/sounds/zapsplat_multimedia_game_zap_laser_011_24956.mp3"
          poolsize="5"
          preload="auto"
        ></audio>

        <audio
          id="explode"
          src="assets/sounds/explosion_distant_003.mp3"
          poolsize="5"
          preload="auto"
        ></audio>
      </a-assets>

      <a-sphere id="left-point" color="red" radius="0.1"></a-sphere>
      <a-sphere id="right-point" color="blue" radius="0.1"></a-sphere>
      <a-sphere id="view-point" color="green" radius="0.1"></a-sphere>

      <a-sphere
        class="hoverable"
        position="0 1.25 -5"
        radius="0.25"
        color="#f60"
      ></a-sphere>

      <a-box
        class="hoverable"
        position="-1 0.5 -3"
        rotation="0 45 0"
        color="#4CC3D9"
        position="0 1.6 0"
        animation="property: position; to: 5 1.6 0; dur: 2000; easing: easeInOutQuad; elasticity: 400; loop: true; dir: alternate"
      ></a-box>

      <a-entity
        gltf-model="#enemy-model-2"
        position="1 1 -5"
        scale="0.5 0.5 0.5"
        rotation="0 0 0"
        animation="property: rotation; delay: 2400; to: 0 270 0; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate"
        modify-materials
      ></a-entity>

      <a-plane
        position="0 0.01 -20"
        rotation="-90 0 0"
        width="4"
        height="40"
        color="#7BC8A4"
        material="src: #chevron; repeat: 4 40"
      ></a-plane>

      <a-entity
        position="0 0 -20"
        rotation="0 0 0"
        animation="property: rotation; to: 180 360 450; loop: true; dur: 5000"
      >
        <a-box position="5 0 0"></a-box>
      </a-entity>

      <a-entity light="type: ambient; color: #222"></a-entity>
      <!-- 

        <a-entity
        light="type: directional; color: #FFF; intensity: 0.3"
        position="-0.5 1 1"
        ></a-entity>
      -->

      <a-entity id="player" position="0 1.91 0" camera-move="speed: 1">
        <a-entity
          id="camera"
          camera
          look-controls
          wasd-controls="acceleration: 200; fly: true"
        >
          <a-entity
            id="cursor"
            cursor="fuse: true; fuseTimeout: 500"
            position="0 0 -1"
            visible="false"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
            material="color: black; shader: flat"
            raycaster="objects: .hoverable"
          >
          </a-entity>
        </a-entity>

        <a-entity
          id="left-hand"
          oculus-touch-controls="hand: left"
          laser-controls="hand: left"
          raycaster="objects: .hoverable"
          line="color: red"
          sound="src: #zap2; on: click"
        >
        </a-entity>

        <a-entity
          id="right-hand"
          oculus-touch-controls="hand: right"
          laser-controls="hand: right"
          raycaster="objects: .hoverable"
          line="color: blue;"
          sound="src: #zap; on: click"
        >
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      var sceneEl = document.querySelector("a-scene");

      var entityEl = document.createElement("a-entity");
      sceneEl.appendChild(entityEl);

      entityEl.setAttribute("geometry", {
        primitive: "cylinder",
        height: 0.1,
        radius: 5
      });

      entityEl.setAttribute("position", {
        x: 0,
        y: -0.1,
        z: 0
      });

      entityEl.setAttribute("material", "color", "red");
      entityEl.setAttribute("material", "opacity", "0.1");
      entityEl.setAttribute("geometry", { primitive: "cylinder" }, true);

      const player = document.querySelector("#player");
      const camera = document.querySelector("#camera");
      //   camera.object3D.position.set(trackRadius, 1.91, 0);

      let posBox = 3;

      function addEnemy(event) {
        entityEl.setAttribute("material", "color", "red");

        var el = sceneEl.components.pool__enemy.requestEntity();
        if (el) {
          el.classList.add("hoverable");
          el.classList.add("enemy");

          el.setAttribute(
            "animation",
            // "property: rotation; delay: 2400; to: 0 270 0; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate"
            "property: rotation;"
          );

          el.setAttribute("position", {
            x: Math.random() * 6 - 3,
            y: 2 + Math.random() * 2,
            z: -posBox
          });

          posBox += 0.65;
        }
      }

      const rightHand = document.querySelector("#right-hand");
      rightHand.addEventListener("triggerdown", function(event) {
        entityEl.setAttribute("material", "color", "blue");

        // player.object3D.position.set(0, 1.91, 0);
      });

      setInterval(addEnemy, 2000);

      rightHand.addEventListener(`click`, shoot);
      leftHand.addEventListener(`click`, shoot);

      function shoot(evt) {
        console.log(evt.detail);
        const clickedEl = evt.detail.intersectedEl;
        if (clickedEl.classList.contains("enemy")) {
          sceneEl.components.pool__enemy.returnEntity(clickedEl);
        }
      }
    </script>
  </body>
</html>
