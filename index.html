<html>
  <head>
    <script src="https://aframe.io/releases/1.0.0/aframe.min.js"></script>
  </head>
  <body>
    <script>
      AFRAME.registerComponent("camera-move", {
        schema: {
          speed: { type: "number", default: 0.01 }
        },
        tick: function() {
          var el = this.el;
          var positionTmp = (this.positionTmp = this.positionTmp || {
            x: 0,
            y: 2,
            z: 0
          });
          var position = el.getAttribute("position");
          // positionTmp.x = position.x + 0.1;
          // positionTmp.y = position.y + 0.001;
          //   positionTmp.z = position.z - 0.005;
          el.setAttribute("position", positionTmp);
        }
      });

      AFRAME.registerComponent("raycaster-listen", {
        init: function() {
          // Use events to figure out what raycaster is listening so we don't have to
          // hardcode the raycaster.
          this.el.addEventListener("raycaster-intersected", evt => {
            this.raycaster = evt.detail.el;
          });
          this.el.addEventListener("raycaster-intersected-cleared", evt => {
            this.raycaster = null;
          });

          this.leftPoint = document.querySelector("#left-point");
          this.rightPoint = document.querySelector("#right-point");
          this.viewPoint = document.querySelector("#view-point");
        },

        tick: function() {
          if (!this.raycaster) {
            return;
          } // Not intersecting.

          let intersection = this.raycaster.components.raycaster.getIntersection(
            this.el
          );
          if (!intersection) {
            return;
          }
          //   console.log(this.raycaster);
          //   console.log(intersection.point);
          const p = intersection.point;

          if (this.raycaster.id === "left-hand") {
            this.leftPoint.object3D.position.set(p.x, p.y, p.z);
          }

          if (this.raycaster.id === "right-hand") {
            this.rightPoint.object3D.position.set(p.x, p.y, p.z);
          }

          if (this.raycaster.id === "cursor") {
            this.viewPoint.object3D.position.set(p.x, p.y, p.z);
          }
        }
      });
    </script>

    <a-scene
      background="color: black"
      pool__enemy="mixin: enemy; size: 6"
      inspector="https://cdn.jsdelivr.net/gh/aframevr/aframe-inspector@master/dist/aframe-inspector.min.js"
    >
      <a-assets>
        <a-mixin
          id="enemy"
          geometry="primitive: box"
          material="color: red"
          scale="0.5 0.5 0.5"
        ></a-mixin>

        <a-mixin id="red" class="red-things"></a-mixin>
        <a-mixin id="blue" material="color: blue"></a-mixin>
      </a-assets>

      <a-entity mixin="red cube"></a-entity>
      <a-entity mixin="blue cube" class="blue-things"></a-entity>

      <a-sphere id="left-point" color="red" radius="0.1"></a-sphere>
      <a-sphere id="right-point" color="blue" radius="0.1"></a-sphere>
      <a-sphere id="view-point" color="green" radius="0.1"></a-sphere>

      <a-sphere
        class="hoverable"
        position="0 1.25 -5"
        radius="1.25"
        color="#EF2D5E"
      ></a-sphere>

      <a-box
        class="hoverable"
        position="-1 0.5 -3"
        rotation="0 45 0"
        color="#4CC3D9"
      ></a-box>

      <a-cylinder
        class="hoverable"
        position="1 0.75 -3"
        radius="0.5"
        height="1.5"
        color="#FFC65D"
      ></a-cylinder>

      <a-plane
        position="0 0 -20"
        rotation="-90 0 0"
        width="4"
        height="40"
        color="#7BC8A4"
      ></a-plane>

      <a-entity light="type: ambient; color: #666"></a-entity>
      <a-entity
        light="type: directional; color: #FFF; intensity: 0.4"
        position="-0.5 1 1"
      ></a-entity>

      <a-entity id="player" position="0 1.91 0" camera-move="speed: 1">
        <a-entity
          id="camera"
          camera
          look-controls
          wasd-controls="acceleration: 200; fly: true"
        >
          <a-entity
            id="cursor"
            cursor="fuse: true; fuseTimeout: 500"
            position="0 0 -1"
            visible="false"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
            material="color: black; shader: flat"
            raycaster="objects: .hoverable"
          >
          </a-entity>
        </a-entity>

        <a-entity
          id="left-hand"
          oculus-touch-controls="hand: left"
          laser-controls="hand: left"
          raycaster="objects: .hoverable"
          line="color: red"
        >
        </a-entity>

        <a-entity
          id="right-hand"
          oculus-touch-controls="hand: right"
          laser-controls="hand: right"
          raycaster="objects: .hoverable"
          line="color: blue;"
        >
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      var sceneEl = document.querySelector("a-scene");

      var entityEl = document.createElement("a-entity");
      sceneEl.appendChild(entityEl);

      entityEl.setAttribute("geometry", {
        primitive: "cylinder",
        height: 0.1,
        radius: 5
      });

      entityEl.setAttribute("position", {
        x: 0,
        y: -0.1,
        z: 0
      });

      entityEl.setAttribute("material", "color", "red");
      entityEl.setAttribute("material", "opacity", "0.1");
      entityEl.setAttribute("geometry", { primitive: "cylinder" }, true);

      const player = document.querySelector("#player");
      const camera = document.querySelector("#camera");
      //   camera.object3D.position.set(trackRadius, 1.91, 0);

      let posBox = 3;

      const leftHand = document.querySelector("#left-hand");
      leftHand.addEventListener("triggerdown", clickThing);

      const cursor = document.querySelector("#cursor");
      cursor.addEventListener("click", clickThing);

      function clickThing(event) {
        entityEl.setAttribute("material", "color", "red");

        var el = sceneEl.components.pool__enemy.requestEntity();
        if (el) {
          //   el.setAttribute("geometry", { primitive: "box" }, true);
          //   el.setAttribute("scale", { x: 0.2, y: 0.2, z: 0.2 });
          el.classList.add("hoverable");
          el.classList.add("enemy");
          //   el.setAttribute("material", "color", "red");
          //   el.setAttribute("mixin", "enemy");

          el.setAttribute("position", {
            x: 3,
            y: 0.75,
            z: -posBox
          });

          posBox += 0.65;
        }
      }

      const rightHand = document.querySelector("#right-hand");
      rightHand.addEventListener("triggerdown", function(event) {
        entityEl.setAttribute("material", "color", "blue");

        // player.object3D.position.set(0, 1.91, 0);
      });

      setInterval(clickThing, 1000);

      rightHand.addEventListener(`click`, function(evt) {
        console.log(evt.detail);
        const clickedEl = evt.detail.intersectedEl;
        if (clickedEl.classList.contains("enemy")) {
          sceneEl.components.pool__enemy.returnEntity(clickedEl);
        }
      });
    </script>
  </body>
</html>
