<html>
  <head>
    <title>TRAVELLING</title>
    <script src="https://aframe.io/releases/1.0.0/aframe.min.js"></script>
    <script src="https://unpkg.com/aframe-environment-component@1.1.0/dist/aframe-environment-component.min.js"></script>
    <script src="https://unpkg.com/aframe-haptics-component/dist/aframe-haptics-component.min.js"></script>
  </head>
  <body>
    <script>
      const MAX_SPEED = 2;
      const ACCELERATION = 0.01;
      const PLAYER_HEIGHT = 1.91;

      let speed = 0;

      AFRAME.registerComponent("camera-move", {
        schema: {
          speed: { type: "number", default: 0.01 }
        },
        tick: function() {
          var el = this.el;
          var positionTmp = (this.positionTmp = this.positionTmp || {
            x: 0,
            y: PLAYER_HEIGHT,
            z: 0
          });
          var position = el.getAttribute("position");
          positionTmp.z = position.z - speed;
          el.setAttribute("position", positionTmp);
        }
      });

      AFRAME.registerComponent("accelerate-listener", {
        init() {
          this.el.addEventListener("gripdown", evt => {
            speed = Math.min(MAX_SPEED, speed + ACCELERATION);
          });
        }
      });

      AFRAME.registerComponent("decelerate-listener", {
        init() {
          this.el.addEventListener("gripdown", evt => {
            speed = Math.max(0, speed - ACCELERATION);
          });
        }
      });

      // AFRAME.registerComponent("raycaster-listen", {
      //   init: function() {
      //     // Use events to figure out what raycaster is listening so we don't have to
      //     // hardcode the raycaster.
      //     this.el.addEventListener("raycaster-intersected", evt => {
      //       this.raycaster = evt.detail.el;
      //     });
      //     this.el.addEventListener("raycaster-intersected-cleared", evt => {
      //       this.raycaster = null;
      //     });

      //     this.leftPoint = document.querySelector("#left-point");
      //     this.rightPoint = document.querySelector("#right-point");
      //     this.viewPoint = document.querySelector("#view-point");
      //   },

      //   tick: function() {
      //     if (!this.raycaster) {
      //       return;
      //     } // Not intersecting.

      //     let intersection = this.raycaster.components.raycaster.getIntersection(
      //       this.el
      //     );
      //     if (!intersection) {
      //       return;
      //     }
      //     //   console.log(this.raycaster);
      //     //   console.log(intersection.point);
      //     const p = intersection.point;

      //     if (this.raycaster.id === "left-hand") {
      //       this.leftPoint.object3D.position.set(p.x, p.y, p.z);
      //     }

      //     if (this.raycaster.id === "right-hand") {
      //       this.rightPoint.object3D.position.set(p.x, p.y, p.z);
      //     }

      //     if (this.raycaster.id === "cursor") {
      //       this.viewPoint.object3D.position.set(p.x, p.y, p.z);
      //     }
      //   }
      // });

      AFRAME.registerComponent("modify-materials", {
        init: function() {
          // Wait for model to load.
          this.el.addEventListener("model-loaded", () => {
            // Grab the mesh / scene.
            const obj = this.el.getObject3D("mesh");
            // Go over the submeshes and modify materials we want.
            obj.traverse(node => {
              // console.log(node);
              if (node.name.indexOf("lamp") !== -1) {
                node.material = new THREE.MeshBasicMaterial();
                node.material.color.set("#f90");
                // node.material = new THREE.MeshLambertMaterial();
                // node.material.emissive.copy(new THREE.Color("#0c0"));
                // node.material.emissiveIntensity = data.intensity;
              }
            });
          });
        }
      });
    </script>

    <a-scene
      background="color: black"
      pool__enemy="mixin: enemy; size: 8"
      inspector="https://cdn.jsdelivr.net/gh/aframevr/aframe-inspector@master/dist/aframe-inspector.min.js"
      google-poly="api_key: AIzaSyAJTX3H29bVUZOK6hB2vSlhiywNKH5YIs4"
      environment="
        seed: 8;
        ground: flat; 
        fog: 0.9; 
        skyType: gradient; 
        playArea: 0;
        horizonColor: #ffcad4; 
        ground: flat;
        groundTexture: none;
        groundColor: #d8e2dc;
        grid: 2x2;
        gridColor: #fff; 
        dressing: trees; 
        dressingColor: #f4acb7;
        dressingAmount: 300; 
        dressingScale: 12w; 
      "
    >
      <a-assets>
        <a-mixin
          id="enemy"
          gltf-model="#enemy1"
          sound="src: #explode; on: click; volume: 10"
          scale="0.5 0.5 0.5"
          animation="property: rotation; dur: 500"
          modify-materials
        >
        </a-mixin>

        <a-mixin
          id="fade-out-text"
          animation="property: components.text.material.uniforms.opacity.value; to: 0; delay: 8000; dur: 3000;"
        >
        </a-mixin>

        <a-mixin id="enemy1-anim"></a-mixin>

        <a-asset-item
          id="enemy1"
          src="assets/models/enemy1.gltf"
        ></a-asset-item>

        <a-asset-item
          id="spinner"
          src="assets/models/spinner.gltf"
        ></a-asset-item>

        <audio
          id="zap"
          src="assets/sounds/Gun Silencer-SoundBible.com-193331132.mp3"
          poolsize="2"
          preload="auto"
        ></audio>

        <audio
          id="explode"
          src="assets/sounds/explosion_distant_003.mp3"
          poolsize="5"
          preload="auto"
        ></audio>
      </a-assets>

      <a-sphere
        class="hoverable"
        position="0 1.25 -5"
        radius="0.5"
        color="#95b88c"
      ></a-sphere>

      <a-plane
        id="travel-path"
        position="0 0.01 0"
        rotation="-90 0 0"
        width="4"
        height="202"
        color="#f4acb7"
      ></a-plane>

      <a-entity
        position="6 8 0"
        animation="property: rotation; delay: 2000; to: 240 360 450; loop: true; easing: easeInOutQuad; dur: 10000; dir: alternate"
      >
        <a-entity
          gltf-model="#spinner"
          scale="4 4 4"
          position="4 4 0"
          color="#346abf"
          animation="property: rotation; to: 0 270 0; dur: 3000; easing: easeInOutQuad; loop: true; dir: alternate"
          modify-materials
        ></a-entity>
      </a-entity>

      <a-entity
        position="-8 12 5"
        rotation="180 0 0"
        animation="property: rotation; delay: 2000; to: 180 240 680; loop: true; easing: easeInOutQuad; dur: 12000; dir: alternate"
      >
        <a-entity
          gltf-model="#spinner"
          scale="4 4 4"
          position="4 4 0"
          color="#346abf"
          animation="property: rotation; to: 0 270 0; dur: 3000; easing: easeInOutQuad; loop: true; dir: alternate"
          modify-materials
        ></a-entity>
      </a-entity>

      <a-entity
        gltf-model="#spinner"
        scale="8 6 8"
        position="0 7 40"
        rotation="200 0 0"
        color="#346abf"
        animation="property: rotation; to: 160 1000 0; dur: 30000; easing: easeInOutQuad; loop: true; dir: alternate"
      ></a-entity>

      <a-entity position="0 0.5 47">
        <a-entity
          position="0 2.8 0"
          text="color: #073e6b; align: center; width: 16; value: TRAVELLING;"
          mixin="fade-out-text"
        ></a-entity>
        <a-entity
          text="color: #073e6b; align: center; width: 6; value: Julian Burgess;"
          position="0 2.3 0"
          mixin="fade-out-text"
        ></a-entity>
        <a-entity
          text="color: #073e6b; align: center; width: 4; value: IS71081B: 3D Virtual Environments and Animation;"
          position="0 2 0"
          mixin="fade-out-text"
        ></a-entity>
        <a-entity
          text="color: #073e6b; align: center; width: 4; value: Goldsmiths 2020;"
          position="0 1.8 0"
          mixin="fade-out-text"
        ></a-entity>
      </a-entity>

      <a-entity id="player" position="0 1.91 50" camera-move="speed: 1">
        <a-entity
          id="camera"
          camera
          look-controls
          wasd-controls="acceleration: 200; fly: true"
        >
          <a-entity
            id="cursor"
            cursor="fuse: false"
            position="0 0 -1"
            visible="false"
            geometry="primitive: ring; radiusInner: 0.02; radiusOuter: 0.03"
            material="color: black; shader: flat"
            raycaster="objects: .hoverable"
          >
          </a-entity>
        </a-entity>

        <a-entity
          id="left-hand"
          accelerate-listener
          oculus-touch-controls="hand: left"
          haptics="events: triggerdown; dur: 50; force: 0.5"
          laser-controls="hand: left"
          raycaster="objects: .hoverable"
          line="color: #5d4a4e"
          sound="src: #zap; on: triggerdown"
        >
          <a-entity position="0 0 -0.1" rotation="-90 0 0">
            <a-entity
              rotation="0 180 0"
              text="color: #073e6b; align: center; width: 0.5; value: Trigger to grow\nGrip to speed up;"
            ></a-entity>
          </a-entity>
        </a-entity>

        <a-entity
          id="right-hand"
          decelerate-listener
          oculus-touch-controls="hand: right"
          haptics="events: triggerdown; dur: 50; force: 0.5"
          laser-controls="hand: right"
          raycaster="objects: .environmentGround"
          line="color: #5d4a4e;"
          sound="src: #zap; on: triggerdown"
        >
          <a-entity position="0 0 -0.1" rotation="-90 0 0">
            <a-entity
              rotation="0 180 0"
              text="color: #073e6b; align: center; width: 0.5; value: Trigger to plant\nGrip to slow down;"
            ></a-entity>
          </a-entity>
        </a-entity>
      </a-entity>
    </a-scene>

    <script>
      var sceneEl = document.querySelector("a-scene");

      const player = document.querySelector("#player");
      const camera = document.querySelector("#camera");

      let posBox = 3;

      function addEnemy(event) {
        var el = sceneEl.components.pool__enemy.requestEntity();
        if (el) {
          el.classList.add("hoverable");
          el.classList.add("enemy");

          el.setAttribute("visible", true);

          // el.setAttribute(
          //   "animation",
          //   // "property: rotation; delay: 2400; to: 0 270 0; dur: 2000; easing: easeInOutQuad; loop: true; dir: alternate"
          //   "property: rotation;"
          // );

          el.setAttribute(
            "animation",
            "property: rotation; to: 0 360 0; loop: true; dur: 10000"
          );

          el.setAttribute("position", {
            x: Math.random() * 6 - 3,
            y: 2 + Math.random() * 2,
            z: -posBox
          });

          posBox += 0.65;
        }
      }

      setInterval(addEnemy, 2000);

      const rightHand = document.querySelector("#right-hand");
      rightHand.addEventListener(`click`, shoot);

      const leftHand = document.querySelector("#left-hand");
      leftHand.addEventListener(`click`, shoot);

      function shoot(evt) {
        const clickedEl = evt.detail.intersectedEl;

        if (clickedEl.classList.contains("environmentGround")) {
          addPlant(evt.detail.intersection.point);
        }
        w;
        if (clickedEl.classList.contains("enemy")) {
          clickedEl.setAttribute("visible", false);
          sceneEl.components.pool__enemy.returnEntity(clickedEl);
        }
      }

      function addPlant(point) {
        const entityEl = document.createElement("a-entity");
        sceneEl.appendChild(entityEl);
        const radius = 0.1 + Math.random();

        entityEl.setAttribute("geometry", {
          primitive: "sphere",
          radius
        });

        const growDuration = 20000;

        point.y += 0.1;

        entityEl.setAttribute("material", "color", "#346abf");
        entityEl.setAttribute("position", point);
        entityEl.setAttribute("scale", "0.1 0.1 0.1");
        entityEl.setAttribute(
          "animation",
          `property: scale; to: 1 1 1; dur: ${growDuration}; easing: easeInOutQuad;`
        );
        entityEl.setAttribute(
          "animation__2",
          `property: position; to: ${point.x} ${point.y + radius} ${
            point.z
          }; dur: ${growDuration}; easing: easeInOutCubic;`
        );
      }
    </script>
  </body>
</html>
